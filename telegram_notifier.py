import requests
from typing import Dict
from config import config

class TelegramNotifier:
    """
    Sends premium formatted trading signals to Telegram
    """

    @staticmethod
    def _escape_markdown(text: str) -> str:
        """
        Escape special characters for Telegram MarkdownV2
        Must escape: _ * [ ] ( ) ~ ` > # + - = | { } . !
        """
        special_chars = ['_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!']
        for char in special_chars:
            text = text.replace(char, f'\\{char}')
        return text

    @staticmethod
    def send_signal(signal: Dict):
        """
        Send trading signal to Telegram channel/group
        """

        direction_emoji = "ğŸŸ¢" if signal['direction'] == "LONG" else "ğŸ”´"
        fire_emoji = "ğŸ”¥" if signal['score'] >= 80 else "âš¡"
        
        # Get values
        pair = signal['pair']
        direction = signal['direction']
        score = signal['score']
        leverage = signal['leverage']
        entry = signal['entry']
        sl = signal['sl']
        tp1 = signal['tp1']
        tp2 = signal['tp2']
        rsi = signal['rsi']
        adx = signal['adx']
        mtf = signal['mtf_trend']
        volume = signal['volume_surge']
        mode = signal.get('mode', 'UNKNOWN')
        timeframe = signal.get('timeframe', 'N/A')
        timestamp = signal['timestamp']

        # Build message with proper escaping
        message = f"""
{fire_emoji} *{direction} SIGNAL* {direction_emoji}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*ğŸ“Š PAIR:* `{pair}`
*ğŸ’¯ SCORE:* {score}/100
*â±ï¸ TIMEFRAME:* {timeframe}
*ğŸ“ˆ LEVERAGE:* {leverage}x

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*ğŸ¯ ENTRY:* â‚¹{entry:,.2f}
*ğŸ›‘ STOP LOSS:* â‚¹{sl:,.2f}
*âœ… TP1:* â‚¹{tp1:,.2f}
*âœ… TP2:* â‚¹{tp2:,.2f}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*ğŸ“‰ RSI:* {rsi}
*ğŸ“Š ADX:* {adx}
*ğŸ”„ MTF:* {mtf}
*ğŸ“¦ Volume:* {volume}x

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*âš™ï¸ MODE:* {mode}
*â° TIME:* {timestamp}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
_Auto\\-generated by ARUN Bot ğŸ¤–_
        """

        # Escape the entire message
        escaped_message = TelegramNotifier._escape_markdown(message.strip())

        TelegramNotifier._send_message(escaped_message, parse_mode='MarkdownV2')

    @staticmethod
    def send_alert(title: str, message: str):
        """Send alert message"""
        
        text = f"""
âš ï¸ *{title}* âš ï¸

{message}
        """
        
        escaped_text = TelegramNotifier._escape_markdown(text.strip())
        TelegramNotifier._send_message(escaped_text, parse_mode='MarkdownV2')

    @staticmethod
    def send_startup_message():
        """Send bot startup notification"""
        
        mode_display = ', '.join(config.ACTIVE_MODES) if config.MULTI_MODE_ENABLED else config.MODE
        auto_trade = 'âœ… ON' if config.AUTO_TRADE else 'âŒ OFF'
        pairs_list = ', '.join(config.PAIRS)

        message = f"""
ğŸš€ *ARUN BOT STARTED* ğŸš€

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*âš™ï¸ Configuration:*
â€¢ Mode: {mode_display}
â€¢ Auto Trade: {auto_trade}
â€¢ Max Signals: {config.MAX_SIGNALS_PER_DAY}/day
â€¢ Pairs: {len(config.PAIRS)}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*ğŸ“Š Trading Pairs:*
{pairs_list}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Bot is now monitoring markets ğŸ‘€
        """

        escaped_message = TelegramNotifier._escape_markdown(message.strip())
        TelegramNotifier._send_message(escaped_message, parse_mode='MarkdownV2')

    @staticmethod
    def send_daily_summary(stats: Dict):
        """Send daily summary"""
        
        mode_display = stats.get('mode', 'N/A')
        signals_today = stats.get('signals_today', 0)
        success_rate = stats.get('success_rate', 'N/A')
        
        # Mode breakdown if available
        breakdown = ""
        if 'mode_breakdown' in stats:
            breakdown = "\n*Breakdown:*\n"
            for mode, count in stats['mode_breakdown'].items():
                breakdown += f"â€¢ {mode}: {count}\n"

        message = f"""
ğŸ“Š *DAILY SUMMARY* ğŸ“Š

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*Signals Generated:* {signals_today}
*Mode:* {mode_display}
*Success Rate:* {success_rate}
{breakdown}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
See you tomorrow! ğŸŒ™
        """

        escaped_message = TelegramNotifier._escape_markdown(message.strip())
        TelegramNotifier._send_message(escaped_message, parse_mode='MarkdownV2')

    @staticmethod
    def _send_message(text: str, parse_mode: str = 'MarkdownV2'):
        """
        Send message to Telegram
        """

        if not config.TELEGRAM_BOT_TOKEN or not config.TELEGRAM_CHAT_ID:
            print("âš ï¸ Telegram credentials not configured")
            print(f"Message: {text}")
            return

        url = f"https://api.telegram.org/bot{config.TELEGRAM_BOT_TOKEN}/sendMessage"

        data = {
            'chat_id': config.TELEGRAM_CHAT_ID,
            'text': text,
            'parse_mode': parse_mode
        }

        try:
            response = requests.post(url, data=data, timeout=10)
            response.raise_for_status()
            print("âœ… Telegram message sent")

        except requests.exceptions.RequestException as e:
            print(f"âŒ Telegram send failed: {e}")
            # Print response for debugging
            if hasattr(e, 'response') and e.response is not None:
                print(f"   Response: {e.response.text}")

    @staticmethod
    def test_connection():
        """Test Telegram bot connection"""
        
        try:
            url = f"https://api.telegram.org/bot{config.TELEGRAM_BOT_TOKEN}/getMe"
            response = requests.get(url, timeout=5)
            response.raise_for_status()

            bot_info = response.json()
            if bot_info['ok']:
                print(f"âœ… Telegram bot connected: @{bot_info['result']['username']}")
                return True
            else:
                print("âŒ Telegram bot connection failed")
                return False

        except requests.exceptions.RequestException as e:
            print(f"âŒ Telegram test failed: {e}")
            return False