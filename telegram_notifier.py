import requests
from typing import Dict
from config import config

class TelegramNotifier:
    """
    Sends trading signals to Telegram (SAFE plain text)
    """

    @staticmethod
    def send_signal(signal: Dict):
        direction_emoji = "ğŸŸ¢" if signal['direction'] == "LONG" else "ğŸ”´"
        fire_emoji = "ğŸ”¥" if signal['score'] >= 80 else "âš¡"

        message = f"""
{fire_emoji} {signal['direction']} SIGNAL {direction_emoji}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š PAIR: {signal['pair']}
ğŸ’¯ SCORE: {signal['score']}/100
â±ï¸ TIMEFRAME: {signal.get('timeframe', 'N/A')}
ğŸ“ˆ LEVERAGE: {signal['leverage']}x

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ ENTRY: â‚¹{signal['entry']:.2f}
ğŸ›‘ STOP LOSS: â‚¹{signal['sl']:.2f}
âœ… TP1: â‚¹{signal['tp1']:.2f}
âœ… TP2: â‚¹{signal['tp2']:.2f}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‰ RSI: {signal['rsi']}
ğŸ“Š ADX: {signal['adx']}
ğŸ”„ MTF: {signal['mtf_trend']}
ğŸ“¦ Volume: {signal['volume_surge']}x

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš™ï¸ MODE: {signal.get('mode', 'UNKNOWN')}
â° TIME: {signal['timestamp']}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Auto-generated by ARUN Bot ğŸ¤–
        """

        TelegramNotifier._send_message(message.strip())

    @staticmethod
    def send_alert(title: str, message: str):
        text = f"""
âš ï¸ {title} âš ï¸

{message}
        """
        TelegramNotifier._send_message(text.strip())

    @staticmethod
    def send_startup_message():
        mode_display = ', '.join(config.ACTIVE_MODES) if config.MULTI_MODE_ENABLED else config.MODE
        auto_trade = 'ON' if config.AUTO_TRADE else 'OFF'

        message = f"""
ğŸš€ ARUN BOT STARTED ğŸš€

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš™ï¸ Mode: {mode_display}
ğŸ¤– Auto Trade: {auto_trade}
ğŸ“ˆ Max Signals: {config.MAX_SIGNALS_PER_DAY}/day
ğŸ“Š Pairs: {len(config.PAIRS)}

Bot is now monitoring markets ğŸ‘€
        """

        TelegramNotifier._send_message(message.strip())

    @staticmethod
    def send_daily_summary(stats: Dict):
        breakdown = ""
        for mode, count in stats.get('mode_breakdown', {}).items():
            breakdown += f"{mode}: {count}\n"

        message = f"""
ğŸ“Š DAILY SUMMARY ğŸ“Š

Signals Today: {stats.get('signals_today', 0)}
Mode: {stats.get('mode', 'N/A')}
Success Rate: {stats.get('success_rate', 'N/A')}

{breakdown}
Good night ğŸŒ™
        """

        TelegramNotifier._send_message(message.strip())

    @staticmethod
    def _send_message(text: str):
        if not config.TELEGRAM_BOT_TOKEN or not config.TELEGRAM_CHAT_ID:
            print("âš ï¸ Telegram not configured")
            print(text)
            return

        url = f"https://api.telegram.org/bot{config.TELEGRAM_BOT_TOKEN}/sendMessage"

        data = {
            "chat_id": config.TELEGRAM_CHAT_ID,
            "text": text  # ğŸ”¥ NO parse_mode
        }

        try:
            r = requests.post(url, json=data, timeout=10)
            r.raise_for_status()
            print("âœ… Telegram message sent")
        except requests.exceptions.RequestException as e:
            print(f"âŒ Telegram send failed: {e}")
            if r is not None:
                print(r.text)