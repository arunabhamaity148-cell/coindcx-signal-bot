import requests
from typing import Dict
from config import config

class TelegramNotifier:
    """
    Sends premium formatted trading signals to Telegram
    """

    @staticmethod
    def send_signal(signal: Dict):
        """
        Send trading signal to Telegram channel/group
        """

        direction_emoji = "ğŸŸ¢" if signal['direction'] == "LONG" else "ğŸ”´"
        fire_emoji = "ğŸ”¥" if signal['score'] >= 80 else "âš¡"

        # Build premium message
        message = f"""
{fire_emoji} *{signal['direction']} SIGNAL* {direction_emoji}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*ğŸ“Š PAIR:* `{signal['pair']}`
*ğŸ’¯ SCORE:* {signal['score']}/100
*ğŸ“ˆ LEVERAGE:* {signal['leverage']}x

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*ğŸ¯ ENTRY:* â‚¹{signal['entry']:,.2f}
*ğŸ›‘ STOP LOSS:* â‚¹{signal['sl']:,.2f}
*âœ… TP1:* â‚¹{signal['tp1']:,.2f}
*âœ… TP2:* â‚¹{signal['tp2']:,.2f}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*ğŸ“‰ RSI:* {signal['rsi']}
*ğŸ“Š ADX:* {signal['adx']} (Trend Strength)
*ğŸ”„ MTF:* {signal['mtf_trend']}
*ğŸ“¦ Volume:* {signal['volume_surge']}x avg

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*âš™ï¸ MODE:* {signal['mode']}
*â° TIME:* {signal['timestamp']}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
_Auto-generated by ARUN Bot ğŸ¤–_
        """

        TelegramNotifier._send_message(message)

    @staticmethod
    def send_alert(title: str, message: str):

        text = f"""
âš ï¸ *{title}* âš ï¸

{message}
        """

        TelegramNotifier._send_message(text)

    @staticmethod
    def send_startup_message():

        message = f"""
ğŸš€ *ARUN BOT STARTED* ğŸš€

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*âš™ï¸ Configuration:*
â€¢ Mode: {config.MODE}
â€¢ Auto Trade: {'âœ… ON' if config.AUTO_TRADE else 'âŒ OFF'}
â€¢ Max Signals: {config.MAX_SIGNALS_PER_DAY}/day
â€¢ Pairs: {len(config.PAIRS)}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*ğŸ“Š Trading Pairs:*
{', '.join(config.PAIRS)}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Bot is now monitoring markets ğŸ‘€
        """

        TelegramNotifier._send_message(message)

    @staticmethod
    def send_daily_summary(stats: Dict):

        message = f"""
ğŸ“Š *DAILY SUMMARY* ğŸ“Š

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*Signals Generated:* {stats['signals_today']}
*Mode:* {stats['mode']}
*Success Rate:* {stats.get('success_rate', 'N/A')}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
See you tomorrow! ğŸŒ™
        """

        TelegramNotifier._send_message(message)

    @staticmethod
    def _send_message(text: str):

        if not config.TELEGRAM_BOT_TOKEN or not config.TELEGRAM_CHAT_ID:
            print("âš ï¸ Telegram credentials not configured")
            print(f"Message: {text}")
            return

        url = f"https://api.telegram.org/bot{config.TELEGRAM_BOT_TOKEN}/sendMessage"

        data = {
            'chat_id': config.TELEGRAM_CHAT_ID,
            'text': text,
            'parse_mode': 'MarkdownV2'
        }

        try:
            response = requests.post(url, data=data, timeout=10)
            response.raise_for_status()
            print("âœ… Telegram message sent")

        except requests.exceptions.RequestException as e:
            print(f"âŒ Telegram send failed: {e}")

    @staticmethod
    def test_connection():
        try:
            url = f"https://api.telegram.org/bot{config.TELEGRAM_BOT_TOKEN}/getMe"
            response = requests.get(url, timeout=5)
            response.raise_for_status()

            bot_info = response.json()
            if bot_info['ok']:
                print(f"âœ… Telegram bot connected: @{bot_info['result']['username']}")
                return True
            else:
                print("âŒ Telegram bot connection failed")
                return False

        except requests.exceptions.RequestException as e:
            print(f"âŒ Telegram test failed: {e}")
            return False